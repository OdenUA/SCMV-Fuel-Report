# Алгоритм анализа топлива и GPS данных

В этом документе описана логика работы приложения SCMV Fuel Report для обнаружения заправок, сливов и сбоев в данных GPS.

## 1. Предварительная обработка данных

Перед анализом "сырые" данные с сервера проходят подготовку:
1.  **Сортировка**: Данные сортируются по времени (timestamp) от старых к новым.
2.  **Фильтрация нулей** (Опционально): Если включена настройка "Фильтровать нули", точки с уровнем топлива < 0.1 л исключаются.
3.  **Расчет метрик**: Для каждой точки относительно предыдущей вычисляются:
    *   `dist`: Пройденное расстояние (км) по формуле Haversine.
    *   `timeDiff`: Разница во времени (часы).
    *   `speed`: Средняя скорость на отрезке (`dist / timeDiff`).

## 2. Обнаружение сбоев GPS (Gap Detection)

Система автоматически определяет пропуски данных или сбои GPS, чтобы избежать ложных срабатываний (например, ложных сливов при телепортации координат).

**Критерии сбоя (разрыва):**
1.  **По времени**: Если разница между точками > `5 минут` (`GAP_THRESHOLD_MS`).
2.  **По расстоянию**: Если расстояние между точками > `3 км` (`GAP_DISTANCE_KM`).

**Влияние на анализ:**
*   Если обнаружен разрыв, текущее отслеживаемое событие (заправка или слив) принудительно завершается.
*   Изменение топлива на участке разрыва **игнорируется** (не считается ни сливом, ни заправкой), так как мы не знаем достоверно, что происходило в этот промежуток времени/расстояния.
*   На карте такой участок отображается **красной пунктирной линией**.

## 3. Алгоритм поиска событий (State Machine)

Анализ выполняется в один проход по данным с использованием конечного автомата. Это позволяет объединять последовательные изменения уровня топлива в одно событие (например, медленная заправка).

### Состояния
*   `currentRefuel`: Активный процесс заправки.
*   `currentDrain`: Активный процесс слива.

### Логика прохода
Для каждой точки `i` вычисляется разница уровня топлива `diff = liters[i] - liters[i-1]`.

1.  **Если топливо растет (`diff > 0`)**:
    *   Если был активен *Слив*, он завершается (`finalizeDrain`).
    *   Если уже идет *Заправка*:
        *   Проверяем паузу. Если с последнего роста прошло < 10 минут (`MERGE_GAP_MS`), продолжаем текущую заправку.
        *   Иначе: завершаем текущую и начинаем новую.
    *   Если *Заправки* нет, начинаем новую.

2.  **Если топливо падает (`diff < 0`)**:
    *   Если была активна *Заправка*, она завершается (`finalizeRefuel`).
    *   Если уже идет *Слив*:
        *   Проверяем паузу. Если с последнего падения прошло < 10 минут, продолжаем текущий слив.
        *   Иначе: завершаем текущий и начинаем новый.
    *   Если *Слива* нет, начинаем новый.

## 4. Валидация событий (Finalization)

После того как событие сформировано, оно проходит проверку перед добавлением в отчет.

### Заправка (`refuel`)
Считается валидной, если:
*   Общий объем изменения (`EndLiters - StartLiters`) >= `Минимальный объем заправки` (настройка, по умолчанию 10л).

### Слив (`drain`)
Считается валидным, если выполняются **все** условия:
1.  Общий объем падения (`StartLiters - EndLiters`) >= `Минимальный объем слива` (настройка, по умолчанию 10л).
2.  **Проверка на расход**:
    *   Вычисляется максимально допустимый расход за время события: `MaxAllowed = DurationHours * MaxConsumptionPerHour`.
    *   Слив засчитывается только если объем падения **превышает** `MaxAllowed`. То есть, это падение нельзя объяснить нормальной работой двигателя.
3.  **Логика "Зажигание"** (Если включена):
    *   Если средняя скорость во время события > 5 км/ч (машина едет), критерии ужесточаются.
    *   Слив в движении засчитывается только если падение **огромное** (в 2 раза больше макс. расхода). Это отсеивает колебания топлива при езде по неровностям.

## 5. Визуализация

*   **Карта**:
    *   Синяя линия: Нормальный трек.
    *   Красная пунктирная: Разрыв данных (сбой GPS).
    *   Зеленый маркер: Заправка.
    *   Красный маркер: Слив.
*   **График**: Отображает "сырые" данные уровня топлива во времени.

## 6. Расчет сводных показателей

### Пробег (Distance)
Рассчитывается как простая сумма расстояний между всеми последовательными точками трека.
*   **Формула**: Haversine (учитывает кривизну Земли).
*   **Особенности**: В текущей версии **не исключает** выбросы GPS при подсчете общей суммы. Если есть "скачок" координат, он добавится в общий пробег.

### Моточасы (Engine Hours)
Рассчитывается как общая длительность временного интервала, охваченного точками.
*   **Формула**: Сумма разниц времени между соседними точками (`Time_Last - Time_First`).
*   **Особенности**:
    *   Не проверяет статус зажигания или скорость.
    *   Является истинными "моточасами" только если GPS-трекер настроен отправлять данные **только при включенном двигателе**.
    *   Если трекер шлет данные круглосуточно, этот показатель будет равен просто прошедшему времени (24ч за сутки).
